---
import type { PaceGrade, Region } from '../types/sanity'

interface Props {
  name: string
  time: string
  location: string
  pace: PaceGrade
  region?: Region
  address?: string
  description?: string
  mapUrl?: string
  url?: string
  urlLabel?: string
  outOfSeason?: boolean
  seasonNote?: string | null
}

const { name, time, location, pace, region, address, description, mapUrl, url, urlLabel = 'Details', outOfSeason = false, seasonNote } = Astro.props

// Pace to dots mapping: A=5, BB=4, B=3, C=2, D=1
const paceDots: Record<string, number> = {
  'A': 5,
  'BB': 4,
  'B': 3,
  'C': 2,
  'D': 1,
}

const filledDots = paceDots[pace] || 3
---

<article
  class:list={['ride-card', { 'out-of-season': outOfSeason }]}
  data-region={region}
  data-pace={pace}
  data-seasonal={outOfSeason ? 'true' : 'false'}
>
  <div class="ride-header" data-ride-toggle>
    <div class="ride-info">
      <div class="ride-title-row">
        <h3 class="ride-title">{name}</h3>
        {outOfSeason && seasonNote && (
          <span class="season-badge">{seasonNote}</span>
        )}
      </div>
      <div class="ride-meta">
        <span class="ride-meta-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          {time}
        </span>
        <span class="ride-meta-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          {location}
        </span>
      </div>
    </div>
    <div class="ride-right">
      <div class="pace-rating">
        {[1, 2, 3, 4, 5].map((dot) => (
          <span class:list={['pace-dot', { filled: dot <= filledDots }]}></span>
        ))}
        <span class="pace-label">{pace}</span>
      </div>
      <svg class="expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </div>
  </div>
  <div class="ride-details">
    {address && (
      <div class="ride-address">
        <span class="ride-address-label">Start</span>
        <span class="ride-address-text">{address}</span>
      </div>
    )}
    {description && <p class="ride-description">{description}</p>}
    <div class="ride-links">
      {mapUrl && (
        <a href={mapUrl} class="ride-link" target="_blank" rel="noopener noreferrer">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          Map
        </a>
      )}
      {url && (
        <a href={url} class:list={['ride-link', 'secondary', { 'strava': urlLabel === 'Strava', 'facebook': urlLabel === 'Facebook' }]} target="_blank" rel="noopener noreferrer">
          {urlLabel}
        </a>
      )}
    </div>
  </div>
</article>

<script>
  // Handle card expansion using event delegation
  // Single listener handles all ride cards via bubbling
  if (!document.documentElement.dataset.rideCardInit) {
    document.documentElement.dataset.rideCardInit = 'true'
    document.addEventListener('click', (event) => {
      const toggle = (event.target as Element).closest('[data-ride-toggle]')
      if (toggle) {
        const card = toggle.closest('.ride-card')
        card?.classList.toggle('expanded')
      }
    })
  }
</script>
