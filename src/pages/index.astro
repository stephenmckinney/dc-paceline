---
import Layout from '../layouts/Layout.astro'
import RideCard from '../components/RideCard.astro'
import { client } from '../../sanity/client'
import type { Ride } from '../types/sanity'

// Fetch published rides from Sanity (excludes drafts)
let rides: Ride[] = []
let fetchError = false

try {
  rides = await client.fetch<Ride[]>(`
    *[_type == "ride" && !(_id in path("drafts.**"))] | order(dayOfWeek asc, time asc) {
      _id,
      name,
      dayOfWeek,
      time,
      location,
      pace,
      description,
      mapUrl,
      url,
      urlLabel
    }
  `)
} catch (error) {
  console.error('Failed to fetch rides from Sanity:', error)
  fetchError = true
}

// Group rides by day of week
const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']
const dayLabels: Record<string, string> = {
  monday: 'Monday',
  tuesday: 'Tuesday',
  wednesday: 'Wednesday',
  thursday: 'Thursday',
  friday: 'Friday',
  saturday: 'Saturday',
  sunday: 'Sunday',
}

const ridesByDay = dayOrder
  .map((day) => ({
    day,
    label: dayLabels[day],
    rides: rides.filter((ride) => ride.dayOfWeek === day),
  }))
  .filter((group) => group.rides.length > 0)
---

<Layout>
  {fetchError ? (
    <div class="empty-state">
      <p>Unable to load rides. Please try again later.</p>
    </div>
  ) : ridesByDay.length === 0 ? (
    <div class="empty-state">
      <p>No rides yet. <a href="/admin">Add some in the Studio</a>.</p>
    </div>
  ) : (
    ridesByDay.map((group) => (
      <section class="day-section">
        <h2 class="day-header">{group.label}</h2>
        {group.rides.map((ride) => (
          <RideCard
            name={ride.name}
            time={ride.time}
            location={ride.location}
            pace={ride.pace}
            description={ride.description}
            mapUrl={ride.mapUrl}
            url={ride.url}
            urlLabel={ride.urlLabel}
          />
        ))}
      </section>
    ))
  )}
</Layout>
