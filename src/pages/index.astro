---
import Layout from '../layouts/Layout.astro'
import RideCard from '../components/RideCard.astro'
import FilterBar from '../components/FilterBar.astro'
import { client } from '../../sanity/client'
import type { RideExpanded } from '../types/sanity'

// Fetch all published rides from Sanity (excludes drafts)
let rides: RideExpanded[] = []
let fetchError = false

try {
  rides = await client.fetch<RideExpanded[]>(`
    *[_type == "ride" && !(_id in path("drafts.**"))] | order(time asc) {
      _id,
      name,
      daysOfWeek,
      time,
      location,
      address,
      mapUrl,
      city->{
        _id,
        name,
        slug,
        region
      },
      group->{
        _id,
        name,
        url,
        ridesUrl
      },
      pace,
      description,
      url,
      urlLabel,
      seasonStart,
      seasonEnd
    }
  `)
} catch (error) {
  console.error('Failed to fetch rides from Sanity:', error)
  fetchError = true
}

// Helper to check if a ride is currently in season
function isInSeason(ride: RideExpanded): boolean {
  // No season defined = year-round
  if (!ride.seasonStart || !ride.seasonEnd) return true

  const currentMonth = new Date().getMonth() + 1 // 1-12

  // Handle wrap-around seasons (e.g., November to March)
  if (ride.seasonStart <= ride.seasonEnd) {
    // Normal range (e.g., April to October)
    return currentMonth >= ride.seasonStart && currentMonth <= ride.seasonEnd
  } else {
    // Wrap-around range (e.g., November to March)
    return currentMonth >= ride.seasonStart || currentMonth <= ride.seasonEnd
  }
}

// Month names for display
const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December']

function getSeasonNote(ride: RideExpanded): string | null {
  if (!ride.seasonStart || !ride.seasonEnd) return null
  return `Runs ${monthNames[ride.seasonStart]}â€“${monthNames[ride.seasonEnd]}`
}

// Format 24-hour time (e.g., "18:00") to 12-hour (e.g., "6:00 PM")
function formatTime(time: string): string {
  const [hours, minutes] = time.split(':').map(Number)
  const period = hours >= 12 ? 'PM' : 'AM'
  const displayHours = hours % 12 || 12
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`
}

// Group rides by day of week
const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']
const dayLabels: Record<string, string> = {
  monday: 'Monday',
  tuesday: 'Tuesday',
  wednesday: 'Wednesday',
  thursday: 'Thursday',
  friday: 'Friday',
  saturday: 'Saturday',
  sunday: 'Sunday',
}

const ridesByDay = dayOrder
  .map((day) => ({
    day,
    label: dayLabels[day],
    rides: rides.filter((ride) => ride.daysOfWeek?.includes(day)),
  }))
  .filter((group) => group.rides.length > 0)
---

<Layout>
  {fetchError ? (
    <div class="empty-state">
      <p>Unable to load rides. Please try again later.</p>
    </div>
  ) : ridesByDay.length === 0 ? (
    <div class="empty-state">
      <p>No rides yet. <a href="/admin">Add some in the Studio</a>.</p>
    </div>
  ) : (
    <>
      <FilterBar />
      <div class="empty-filtered" id="empty-filtered">
        <p>No rides match your filters. Try adjusting your selections.</p>
      </div>
      {ridesByDay.map((group) => (
      <section class="day-section">
        <h2 class="day-header">{group.label}</h2>
        {group.rides.map((ride) => (
          <RideCard
            name={ride.name}
            time={formatTime(ride.time)}
            location={ride.location}
            pace={ride.pace}
            region={ride.city?.region}
            address={ride.address}
            description={ride.description}
            mapUrl={ride.mapUrl}
            url={ride.url}
            urlLabel={ride.urlLabel}
            outOfSeason={!isInSeason(ride)}
            seasonNote={getSeasonNote(ride)}
          />
        ))}
      </section>
      ))}
    </>
  )}
</Layout>
